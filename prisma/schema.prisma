// JuanRide Database Schema (Prisma)
// This is your Prisma schema file for the vehicle rental platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  renter
  owner
  admin
}

enum VehicleType {
  scooter
  motorcycle
  car
  van
}

enum VehicleStatus {
  available
  rented
  maintenance
  inactive
}

enum TransmissionType {
  manual
  automatic
}

enum FuelType {
  gasoline
  diesel
  electric
  hybrid
}

enum BookingStatus {
  pending
  confirmed
  active
  completed
  cancelled
}

enum PaymentMethod {
  gcash
  maya
  card
  bank_transfer
}

enum PaymentStatus {
  pending
  processing
  paid
  failed
  refunded
}

enum NotificationType {
  booking
  payment
  message
  review
  system
  maintenance
}

enum DisputeType {
  damage
  late_return
  payment
  behavior
  other
}

enum DisputeStatus {
  open
  investigating
  resolved
  closed
}

// ============================================================================
// MODELS
// ============================================================================

model User {
  id                String   @id @db.Uuid
  email             String   @unique
  fullName          String?  @map("full_name")
  phoneNumber       String?  @map("phone_number")
  role              UserRole @default(renter)
  profileImageUrl   String?  @map("profile_image_url")
  dateOfBirth       DateTime? @map("date_of_birth") @db.Date
  address           String?
  isVerified        Boolean  @default(false) @map("is_verified")
  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relationships
  vehicles          Vehicle[]         @relation("VehicleOwner")
  bookingsAsRenter  Booking[]         @relation("RenterBookings")
  bookingsAsOwner   Booking[]         @relation("OwnerBookings")
  reviews           Review[]          @relation("Reviewer")
  reviewsReceived   Review[]          @relation("ReviewedOwner")
  messagesSent      Message[]         @relation("MessageSender")
  messagesReceived  Message[]         @relation("MessageReceiver")
  notifications     Notification[]
  favorites         Favorite[]
  disputesReported  Dispute[]         @relation("DisputeReporter")
  disputesAgainst   Dispute[]         @relation("DisputeDefendant")
  disputesResolved  Dispute[]         @relation("DisputeResolver")

  @@map("users")
}

model Vehicle {
  id              String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  ownerId         String         @map("owner_id") @db.Uuid
  type            VehicleType
  make            String?
  model           String?
  year            Int?
  plateNumber     String         @unique @map("plate_number")
  description     String?
  pricePerDay     Decimal        @map("price_per_day") @db.Decimal(10, 2)
  pricePerWeek    Decimal?       @map("price_per_week") @db.Decimal(10, 2)
  pricePerMonth   Decimal?       @map("price_per_month") @db.Decimal(10, 2)
  status          VehicleStatus  @default(available)
  location        String?
  imageUrls       String[]       @default([]) @map("image_urls")
  features        Json?          @default("{}")
  rentalTerms     String?        @map("rental_terms")
  transmission    TransmissionType?
  fuelType        FuelType?      @map("fuel_type")
  isApproved      Boolean        @default(false) @map("is_approved")
  adminNotes      String?        @map("admin_notes")
  createdAt       DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime       @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relationships
  owner           User           @relation("VehicleOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  bookings        Booking[]
  reviews         Review[]
  maintenanceLogs MaintenanceLog[]
  blockedDates    BlockedDate[]
  favorites       Favorite[]

  @@index([ownerId])
  @@index([status])
  @@index([type])
  @@map("vehicles")
}

model Booking {
  id               String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  renterId         String        @map("renter_id") @db.Uuid
  vehicleId        String        @map("vehicle_id") @db.Uuid
  ownerId          String        @map("owner_id") @db.Uuid
  startDate        DateTime      @map("start_date") @db.Date
  endDate          DateTime      @map("end_date") @db.Date
  totalPrice       Decimal       @map("total_price") @db.Decimal(10, 2)
  status           BookingStatus @default(pending)
  pickupTime       DateTime?     @map("pickup_time") @db.Time(6)
  returnTime       DateTime?     @map("return_time") @db.Time(6)
  pickupLocation   String?       @map("pickup_location")
  returnLocation   String?       @map("return_location")
  specialRequests  String?       @map("special_requests")
  cancellationReason String?     @map("cancellation_reason")
  createdAt        DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relationships
  renter           User          @relation("RenterBookings", fields: [renterId], references: [id], onDelete: Cascade)
  vehicle          Vehicle       @relation(fields: [vehicleId], references: [id], onDelete: Restrict)
  owner            User          @relation("OwnerBookings", fields: [ownerId], references: [id], onDelete: Cascade)
  payments         Payment[]
  reviews          Review[]
  messages         Message[]
  disputes         Dispute[]

  @@index([renterId])
  @@index([vehicleId])
  @@index([ownerId])
  @@index([status])
  @@index([startDate, endDate])
  @@map("bookings")
}

model Payment {
  id                      String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  bookingId               String        @map("booking_id") @db.Uuid
  amount                  Decimal       @db.Decimal(10, 2)
  paymentMethod           PaymentMethod @map("payment_method")
  status                  PaymentStatus @default(pending)
  transactionId           String?       @map("transaction_id")
  paymentGatewayResponse  Json?         @map("payment_gateway_response")
  paidAt                  DateTime?     @map("paid_at") @db.Timestamptz(6)
  refundedAt              DateTime?     @map("refunded_at") @db.Timestamptz(6)
  refundAmount            Decimal?      @map("refund_amount") @db.Decimal(10, 2)
  platformFee             Decimal?      @default(0) @map("platform_fee") @db.Decimal(10, 2)
  ownerPayout             Decimal?      @map("owner_payout") @db.Decimal(10, 2)
  createdAt               DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt               DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relationships
  booking                 Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([status])
  @@map("payments")
}

model Review {
  id                   String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  bookingId            String    @map("booking_id") @db.Uuid
  reviewerId           String    @map("reviewer_id") @db.Uuid
  vehicleId            String    @map("vehicle_id") @db.Uuid
  ownerId              String    @map("owner_id") @db.Uuid
  rating               Int
  comment              String?
  cleanlinessRating    Int?      @map("cleanliness_rating")
  conditionRating      Int?      @map("condition_rating")
  valueRating          Int?      @map("value_rating")
  communicationRating  Int?      @map("communication_rating")
  imageUrls            String[]  @default([]) @map("image_urls")
  isAnonymous          Boolean   @default(false) @map("is_anonymous")
  isApproved           Boolean   @default(true) @map("is_approved")
  adminNotes           String?   @map("admin_notes")
  ownerResponse        String?   @map("owner_response")
  ownerResponseAt      DateTime? @map("owner_response_at") @db.Timestamptz(6)
  createdAt            DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relationships
  booking              Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  reviewer             User      @relation("Reviewer", fields: [reviewerId], references: [id], onDelete: Cascade)
  vehicle              Vehicle   @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  owner                User      @relation("ReviewedOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  @@unique([bookingId, reviewerId])
  @@index([vehicleId])
  @@index([ownerId])
  @@index([rating])
  @@map("reviews")
}

model Message {
  id         String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  bookingId  String    @map("booking_id") @db.Uuid
  senderId   String    @map("sender_id") @db.Uuid
  receiverId String    @map("receiver_id") @db.Uuid
  content    String
  isRead     Boolean   @default(false) @map("is_read")
  readAt     DateTime? @map("read_at") @db.Timestamptz(6)
  imageUrl   String?   @map("image_url")
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relationships
  booking    Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  sender     User      @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver   User      @relation("MessageReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([senderId])
  @@index([receiverId])
  @@map("messages")
}

model MaintenanceLog {
  id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  vehicleId       String    @map("vehicle_id") @db.Uuid
  serviceType     String    @map("service_type")
  serviceDate     DateTime  @map("service_date") @db.Date
  description     String?
  cost            Decimal?  @db.Decimal(10, 2)
  serviceProvider String?   @map("service_provider")
  nextServiceDate DateTime? @map("next_service_date") @db.Date
  odometerReading Int?      @map("odometer_reading")
  notes           String?
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relationships
  vehicle         Vehicle   @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
  @@index([serviceDate])
  @@map("maintenance_logs")
}

model Notification {
  id        String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId    String           @map("user_id") @db.Uuid
  type      NotificationType
  title     String
  message   String
  link      String?
  isRead    Boolean          @default(false) @map("is_read")
  readAt    DateTime?        @map("read_at") @db.Timestamptz(6)
  metadata  Json?
  createdAt DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relationships
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model BlockedDate {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  vehicleId String   @map("vehicle_id") @db.Uuid
  startDate DateTime @map("start_date") @db.Date
  endDate   DateTime @map("end_date") @db.Date
  reason    String?
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relationships
  vehicle   Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
  @@index([startDate, endDate])
  @@map("blocked_dates")
}

model Favorite {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  vehicleId String   @map("vehicle_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relationships
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  vehicle   Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@unique([userId, vehicleId])
  @@index([userId])
  @@index([vehicleId])
  @@map("favorites")
}

model Dispute {
  id               String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  bookingId        String        @map("booking_id") @db.Uuid
  reportedBy       String        @map("reported_by") @db.Uuid
  reportedAgainst  String        @map("reported_against") @db.Uuid
  type             DisputeType
  description      String
  evidenceUrls     String[]      @default([]) @map("evidence_urls")
  status           DisputeStatus @default(open)
  resolution       String?
  resolvedBy       String?       @map("resolved_by") @db.Uuid
  resolvedAt       DateTime?     @map("resolved_at") @db.Timestamptz(6)
  createdAt        DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relationships
  booking          Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  reporter         User          @relation("DisputeReporter", fields: [reportedBy], references: [id], onDelete: Cascade)
  defendant        User          @relation("DisputeDefendant", fields: [reportedAgainst], references: [id], onDelete: Cascade)
  resolver         User?         @relation("DisputeResolver", fields: [resolvedBy], references: [id])

  @@index([bookingId])
  @@index([status])
  @@map("disputes")
}
